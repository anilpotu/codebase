{{- if .Values.global.istio.enabled }}
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: {{ .Values.global.namespace }}
spec:
  {}
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-ingress-gateway
  namespace: {{ .Values.global.namespace }}
spec:
  selector:
    matchLabels:
      app: api-gateway
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-health-probes
  namespace: {{ .Values.global.namespace }}
spec:
  action: ALLOW
  rules:
    - to:
        - operation:
            paths:
              - "/actuator/health"
              - "/actuator/health/*"
            methods: ["GET"]
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-api-gateway-to-auth-service
  namespace: {{ .Values.global.namespace }}
spec:
  selector:
    matchLabels:
      app: auth-service
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/api-gateway"
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-api-gateway-to-user-service
  namespace: {{ .Values.global.namespace }}
spec:
  selector:
    matchLabels:
      app: user-service
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/api-gateway"
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-api-gateway-to-order-service
  namespace: {{ .Values.global.namespace }}
spec:
  selector:
    matchLabels:
      app: order-service
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/api-gateway"
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-api-gateway-to-product-service
  namespace: {{ .Values.global.namespace }}
spec:
  selector:
    matchLabels:
      app: product-service
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/api-gateway"
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-services-to-config-server
  namespace: {{ .Values.global.namespace }}
spec:
  selector:
    matchLabels:
      app: config-server
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/api-gateway"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/auth-service"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/user-service"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/order-service"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/product-service"
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-services-to-eureka-server
  namespace: {{ .Values.global.namespace }}
spec:
  selector:
    matchLabels:
      app: eureka-server
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/api-gateway"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/auth-service"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/user-service"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/order-service"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/product-service"
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-services-to-redis
  namespace: {{ .Values.global.namespace }}
spec:
  selector:
    matchLabels:
      app: redis
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/api-gateway"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/auth-service"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/user-service"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/order-service"
              - "cluster.local/ns/{{ .Values.global.namespace }}/sa/product-service"
{{- end }}
